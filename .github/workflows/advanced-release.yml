name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      app_version: ${{ steps.get_version.outputs.version }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      
    - name: Get app version from code
      id: get_version
      run: |
        # ä» src/common.py è¯»å–ç‰ˆæœ¬å·
        version=$(grep 'APP_VERSION = ' src/common.py | sed 's/.*APP_VERSION = "\(.*\)".*/\1/')
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "App version: $version"
        
    - name: Create virtual environment and install dependencies
      run: |
        uv venv
        uv pip install -r requirements.txt
        uv pip install pyinstaller
        
    - name: Build application (following build.bat logic)
      run: |
        # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶æ„å»ºåº”ç”¨ (æ¨¡æ‹Ÿ build.bat è¡Œä¸º)
        source .venv/bin/activate
        
        # æ„å»ºåº”ç”¨ (æŒ‰ç…§ build.bat çš„å‘½ä»¤)
        pyinstaller --name "nightreign-overlay-helper" --windowed --icon="assets/icon.ico" src/app.py
        
        # å¤åˆ¶èµ„æºæ–‡ä»¶ (æ¨¡æ‹Ÿ build.bat ä¸­çš„ xcopy å’Œ copy å‘½ä»¤)
        cp -r assets dist/nightreign-overlay-helper/
        cp -r data dist/nightreign-overlay-helper/
        cp manual.txt dist/nightreign-overlay-helper/
        cp config.yaml dist/nightreign-overlay-helper/
        
        # éªŒè¯æ„å»ºç»“æœ
        if [ -f "dist/nightreign-overlay-helper/nightreign-overlay-helper" ]; then
          echo "âœ“ æ„å»ºæˆåŠŸ"
          ls -lh dist/nightreign-overlay-helper/nightreign-overlay-helper
        else
          echo "âœ— æ„å»ºå¤±è´¥"
          exit 1
        fi
      
    - name: Create release package
      run: |
        cd dist
        
        # è·å–æ ‡ç­¾å
        if [ "${{ github.ref_name }}" != "" ]; then
          TAG_NAME="${{ github.ref_name }}"
        else
          TAG_NAME="${{ github.event.inputs.version }}"
        fi
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        cat > nightreign-overlay-helper/VERSION.txt << EOF
é»‘å¤œå›ä¸´æ‚¬æµ®åŠ©æ‰‹ $TAG_NAME
æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
æ„å»ºç¯å¢ƒ: GitHub Actions (Linux)
ä»£ç ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}

ä½¿ç”¨æ–¹æ³•:
1. ç¡®ä¿æ¸¸æˆ ELDEN RING NIGHTREIGN å·²å®‰è£…
2. è¿è¡Œ nightreign-overlay-helper.exe (Windows ç‰ˆæœ¬)
3. æŒ‰ç…§ç•Œé¢æç¤ºè¿›è¡Œè®¾ç½®

æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ manual.txt

æ³¨æ„: æ­¤ç‰ˆæœ¬åœ¨ Linux ç¯å¢ƒæ„å»ºï¼Œä½†ç›®æ ‡å¹³å°ä¸º Windows
EOF
        
        # åˆ›å»ºå‹ç¼©åŒ…
        ZIP_NAME="nightreign-overlay-helper-$TAG_NAME.zip"
        zip -r "$ZIP_NAME" nightreign-overlay-helper/
        
        echo "Created: $ZIP_NAME"
        ls -lh "$ZIP_NAME"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nightreign-overlay-helper-build
        path: dist/nightreign-overlay-helper-*.zip
        retention-days: 30
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: nightreign-overlay-helper-build
        path: ./artifacts
        
    - name: Generate release notes
      id: release_notes
      run: |
        TAG_NAME="${{ github.ref_name }}"
        APP_VERSION="${{ needs.build.outputs.app_version }}"
        
        # ä» git å†å²ç”Ÿæˆæ›´æ–°æ—¥å¿—
        CHANGELOG=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "HEAD~10")..HEAD 2>/dev/null || echo "- åˆå§‹å‘å¸ƒ")
        
        cat > release_notes.md << EOF
## ğŸ® é»‘å¤œå›ä¸´æ‚¬æµ®åŠ©æ‰‹ ${TAG_NAME}

### ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
- **åº”ç”¨ç‰ˆæœ¬**: ${APP_VERSION}
- **å‘å¸ƒæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
- **æ„å»ºç¯å¢ƒ**: GitHub Actions (Linux)

### ğŸ†• æ›´æ–°å†…å®¹
${CHANGELOG}

### ğŸ“¥ ä¸‹è½½å’Œå®‰è£…
1. ä¸‹è½½ä¸‹æ–¹çš„ \`nightreign-overlay-helper-${TAG_NAME}.zip\`
2. è§£å‹åˆ°ä»»æ„ç›®å½•
3. è¿è¡Œ \`nightreign-overlay-helper.exe\`
4. æŒ‰ç…§ç•Œé¢æç¤ºè¿›è¡Œåˆå§‹è®¾ç½®

### ğŸ’» ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Windows 10/11 (64ä½)
- **æ¸¸æˆ**: ELDEN RING NIGHTREIGN
- **å†…å­˜**: å»ºè®® 4GB ä»¥ä¸Š

### ğŸ“– ä½¿ç”¨è¯´æ˜
è¯¦ç»†ä½¿ç”¨æ–¹æ³•è¯·æŸ¥çœ‹å‹ç¼©åŒ…ä¸­çš„ \`manual.txt\` æ–‡ä»¶ã€‚

### ğŸ› é—®é¢˜æŠ¥å‘Š
å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚

---
*æ­¤ç‰ˆæœ¬é€šè¿‡ GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
EOF
        
        # è¾“å‡ºåˆ° GitHub Actions
        {
          echo "release_notes<<EOF"
          cat release_notes.md
          echo "EOF"
        } >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: "é»‘å¤œå›ä¸´æ‚¬æµ®åŠ©æ‰‹ ${{ github.ref_name }}"
        body: ${{ steps.release_notes.outputs.release_notes }}
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        files: |
          ./artifacts/nightreign-overlay-helper-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}